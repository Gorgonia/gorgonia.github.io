<!DOCTYPE html>
<html>
  <head>
    <title>Gorgonia - Deep Learning Library for Go</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.47.1" />
<title>Example :: Gorgonia - Deep Learning Library for Go</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "https:\/\/gorgonia.org\/";
</script>
<meta name="description" content="Gorgonia is a suite of libraries for creating performant deep learning and machine learning applications in Go">
<meta name="author" content="Gorgonia Authors">


    
  </head>
  <body data-url="/usage/cuda/example/">
    
      <header>
  <div class="logo">
    
	
  
    <a class="baselink" href="https://gorgonia.org/">Gorgonia - Deep Learning Library for Go</a>
  

  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://github.com/gorgonia/gorgonia"  rel="noopener">
                  <i class='fa fa-github'></i> <label>Github repo</label>
                </a>
            </li>
            <li class="" role="">
                <a href="https://godoc.org/gorgonia.org/gorgonia"  rel="noopener">
                  <i class='fa fa-bookmark'></i> <label>GoDoc</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/" class="dd-item">
          <a href="/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/about/" class="dd-item
        ">
      <div>
      <a href="/about/">Why use Gorgonia? </a>
      </div>
    </li>
    <li data-nav-id="/getting-started/" class="dd-item alwaysopen
        ">
      <div>
      <a href="/getting-started/">Installation</a>
      </div>
    </li>
    <li data-nav-id="/usage/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/usage/">Usage</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/usage/vm/" class="dd-item">
        <div>
          <a href="/usage/vm/">
            VM
          </a>
        </div>
    </li>
      <li data-nav-id="/usage/differenciation/" class="dd-item">
        <div>
          <a href="/usage/differenciation/">
            Differentiation
          </a>
        </div>
    </li>
      <li data-nav-id="/usage/graph/" class="dd-item">
        <div>
          <a href="/usage/graph/">
            Graph
          </a>
        </div>
    </li>
    <li data-nav-id="/usage/cuda/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/usage/cuda/">CUDA  </a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/usage/cuda/example/" class="dd-item active">
        <div>
          <a href="/usage/cuda/example/">
            Example
          </a>
        </div>
    </li>
      <li data-nav-id="/usage/cuda/ops/" class="dd-item">
        <div>
          <a href="/usage/cuda/ops/">
            Op&#39;s supported by CUDA
          </a>
        </div>
    </li>
      <li data-nav-id="/usage/cuda/improvements/" class="dd-item">
        <div>
          <a href="/usage/cuda/improvements/">
            Improvements
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/contributing/" class="dd-item
        ">
      <div>
      <a href="/contributing/">Contributing</a>
      </div>
    </li>
    <li data-nav-id="/copyright/" class="dd-item alwaysopen
        ">
      <div>
      <a href="/copyright/">Copyright</a>
      </div>
    </li>
    <li data-nav-id="/support/" class="dd-item haschildren
        ">
      <div>
      <a href="/support/">Support</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/support/faq/" class="dd-item">
        <div>
          <a href="/support/faq/">
            FAQ
          </a>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/about/" >
   Why use Gorgonia? </option>
    <option value="/getting-started/" >
   Installation</option> 
  
    <option value="/usage/" >
   Usage</option> 
      <option value="/usage/vm/" >- VM</option>
      <option value="/usage/differenciation/" >- Differentiation</option>
      <option value="/usage/graph/" >- Graph</option>
    <option value="/usage/cuda/" >
  - 
   CUDA  </option> 
      <option value="/usage/cuda/example/"  selected>-- Example</option>
      <option value="/usage/cuda/ops/" >-- Op&#39;s supported by CUDA</option>
      <option value="/usage/cuda/improvements/" >-- Improvements</option>
  
  
    <option value="/contributing/" >
   Contributing</option>
    <option value="/copyright/" >
   Copyright</option> 
  
    <option value="/support/" >
   Support</option>



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
        <script type="text/javascript" src="/js/lunr.min.js"></script>
        <script type="text/javascript" src="/js/auto-complete.js"></script>
        <link href="/css/auto-complete.css" rel="stylesheet">
        <script type="text/javascript">
          
              var baseurl = "https:\/\/gorgonia.org\/";
          
        </script>
        <script type="text/javascript" src="/js/search.js"></script>
      </div>
    

    <h1>Example</h1>
    
    
    
    

<p>So how do we use CUDA? Say we&rsquo;ve got a file, <code>main.go</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;runtime&#34;</span>

	<span class="nx">T</span> <span class="s">&#34;gorgonia.org/gorgonia&#34;</span>
	<span class="s">&#34;gorgonia.org/tensor&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">g</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">.</span><span class="nx">NewGraph</span><span class="p">()</span>
	<span class="nx">x</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">.</span><span class="nx">NewMatrix</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">T</span><span class="p">.</span><span class="nx">Float32</span><span class="p">,</span> <span class="nx">T</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&#34;x&#34;</span><span class="p">),</span> <span class="nx">T</span><span class="p">.</span><span class="nx">WithShape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
	<span class="nx">y</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">.</span><span class="nx">NewMatrix</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">T</span><span class="p">.</span><span class="nx">Float32</span><span class="p">,</span> <span class="nx">T</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&#34;y&#34;</span><span class="p">),</span> <span class="nx">T</span><span class="p">.</span><span class="nx">WithShape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
	<span class="nx">xpy</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">T</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span>
	<span class="nx">xpy2</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">T</span><span class="p">.</span><span class="nx">Tanh</span><span class="p">(</span><span class="nx">xpy</span><span class="p">))</span>

	<span class="nx">m</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">.</span><span class="nx">NewTapeMachine</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">T</span><span class="p">.</span><span class="nx">UseCudaFor</span><span class="p">(</span><span class="s">&#34;tanh&#34;</span><span class="p">))</span>

	<span class="nx">T</span><span class="p">.</span><span class="nx">Let</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tensor</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">tensor</span><span class="p">.</span><span class="nx">WithShape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="nx">tensor</span><span class="p">.</span><span class="nx">WithBacking</span><span class="p">(</span><span class="nx">tensor</span><span class="p">.</span><span class="nx">Random</span><span class="p">(</span><span class="nx">tensor</span><span class="p">.</span><span class="nx">Float32</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="mi">100</span><span class="p">))))</span>
	<span class="nx">T</span><span class="p">.</span><span class="nx">Let</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">tensor</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">tensor</span><span class="p">.</span><span class="nx">WithShape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="nx">tensor</span><span class="p">.</span><span class="nx">WithBacking</span><span class="p">(</span><span class="nx">tensor</span><span class="p">.</span><span class="nx">Random</span><span class="p">(</span><span class="nx">tensor</span><span class="p">.</span><span class="nx">Float32</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="mi">100</span><span class="p">))))</span>

	<span class="nx">runtime</span><span class="p">.</span><span class="nx">LockOSThread</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">RunAll</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&#34;iteration: %d. Err: %v&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">runtime</span><span class="p">.</span><span class="nx">UnlockOSThread</span><span class="p">()</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;%1.1f&#34;</span><span class="p">,</span> <span class="nx">xpy2</span><span class="p">.</span><span class="nx">Value</span><span class="p">())</span>
<span class="p">}</span></code></pre></div>
<p>If this is run normally:</p>

<pre><code>go run main.go
</code></pre>

<p>CUDA will not be used.</p>

<p>If the program is to be run using CUDA, then this must be invoked:</p>

<pre><code>go run -tags='cuda'
</code></pre>

<p>And even so, only the <code>tanh</code> function uses CUDA.</p>

<h2 id="rationale">Rationale</h2>

<p>The main reasons for having such complicated requirements for using CUDA is quite simply performance related. As Dave Cheney famously wrote, <a href="https://dave.cheney.net/2016/01/18/cgo-is-not-go">cgo is not Go</a>. To use CUDA, cgo is unfortunately required. And to use cgo, plenty of tradeoffs need to be made.</p>

<p>Therefore the solution was to nestle the CUDA related code in a build tag, <code>cuda</code>. That way by default no cgo is used (well, kind-of - you could still use <code>cblas</code> or <code>blase</code>).</p>

<p>The reason for requiring <a href="https://developer.nvidia.com/cuda-toolkit">CUDA toolkit 8.0</a> is because there are many CUDA <a href="http://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#compute-capabilities">Compute Capabilities</a>, and generating code for them all would yield a huge binary for no real good reason. Rather, users are encouraged to compile for their specific Compute Capabilities.</p>

<p>Lastly, the reason for requiring an explicit specification to use CUDA for which ops is due to the cost of cgo calls. Additional work is being done currently to implement batched cgo calls,  but until that is done, the solution is keyhole &ldquo;upgrade&rdquo; of certain ops</p>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/usage/cuda/" title="CUDA  "> <i class="fa fa-chevron-left"></i><label>CUDA  </label></a>
    <a class="nav nav-next" href="/usage/cuda/ops/" title="Op&#39;s supported by CUDA" style="margin-right: 0px;"><label>Op&#39;s supported by CUDA</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

  
    <div class="date">
        <i class='fa fa-calendar'></i> Last update on 24/09/2018
    </div>
    

    <div class="github-link">
      <a href="https://github.com/gorgonia/gorgonia.github.io/tree/master/src/content/usage/cuda/example.md" target="blank"><i class="fa fa-code-fork"></i>
        Improve this page</a>
    </div>
  </div>


	<div>


  
    
  



	</div>
</footer>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/theme-flex/script.js"></script>

    

    
    

    
  </body>
</html>